<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
</head>
        <!--jquery-->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <!--時間處理插件-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
<script>
    function getList(dataset, datasetNumber, callback) {
        $.get("https://spreadsheets.google.com/feeds/list/" + dataset + "/" + datasetNumber + "/public/values?alt=json").then(function(data) { callback(data); });
    }

    var mainList = [];
    var productsObj = {};

    getList('1TM8EMwou-jLGQIhnlHtE7_rX50GV2rCbiLTSfkicoo0', '1', function(data) {
        getList('1TM8EMwou-jLGQIhnlHtE7_rX50GV2rCbiLTSfkicoo0', '2', function(productsObjData) {
            
            productsObj = JSON.parse(productsObjData.feed.entry[0].gsx$productsobj.$t);

            var d = data.feed.entry;
            for (var i in d) {
                if (d[i].gsx$timestamp.$t === '/') {
                    continue;
                }
                var row = {
                    'timestamp': new Date(d[i].gsx$timestamp.$t.replace(/-/g, '/')),
                    'orderNumber': d[i].gsx$ordernumber.$t,
                    'department': d[i].gsx$department.$t,
                    'grade': d[i].gsx$grade.$t,
                    'time': d[i].gsx$time.$t,
                    'total': parseInt(d[i].gsx$total.$t),
                    'order': JSON.parse(d[i].gsx$order.$t),
                }
                mainList.push(row);
            }



            var body = document.querySelector('body');
            var orderObj = {};
            var discountObj = {'total': {'discount': 0, 'count': 0}};
            var timeObj = {};
            var timeHourList = {};

            var pTable = document.createElement('table');
                pTable.id = 'customers';
            var pTbody = document.createElement('tbody');

                pTbody.innerHTML += '<tr>' 
                + '<th>' + '年' 
                + '</th><th>' + '月' 
                + '</th><th>' + '日' 
                + '</th><th>' + '時' 
                + '</th><th>' + '訂單編號' 
                + '</th><th>' + '系所' 
                + '</th><th>' + '年級' 
                + '</th><th>' + '折扣碼' 
                + '</th><th>' + 'Total' 
                + '</th><th>' + 'Discount' 
                + '</th><th>' + 'Subtotal' 
                + '</th><th>' + 'Discount' 
                + '</th><th>' + 'Cost' 
                + '</th><th>' + 'Profit' 
                + '</th>' + '</tr>';

            var TPtotal = 0;
            var TPdiscount = 0;
            var TPsubtotal = 0;
            var TPcost = 0;
            var TPprofit = 0;

            for (var i = 0; i < mainList.length; i++) {
                var timestamp = mainList[i].timestamp;

                var year = moment(timestamp).format('YYYY');
                var month = moment(timestamp).format('MM');
                var day = moment(timestamp).format('DD');
                var hour = moment(timestamp).format('HH');

                var orderNumber = mainList[i].orderNumber;
                var department = mainList[i].department.substring(0, 3);
                var grade = mainList[i].grade.substring(0, 1);
                var time = new Date(mainList[i].time.split(' ')[0].replace(/-/g, '/'));
                var timeDay = parseInt(moment(time).format('DD'));
                var total = mainList[i].total;
                var order = mainList[i].order;

                var discount = mainList[i].order.totalDiscount + mainList[i].order.merchantDiscount;
                var coupon = mainList[i].order.coupon.substring(0, 3) || '無';

                var Psubtotal = 0;
                var Pcost = 0;
                var Pprofit = 0;

                discountObj.total.discount += order.totalDiscount;
                if (order.totalDiscount > 0) {
                    discountObj.total.count ++;
                }

                for (var m in order) {
                    if (typeof order[m] != 'object') {
                        continue;
                    }
                    if (!(m in orderObj)) {
                        orderObj[m] = {};
                    }
                    if (!(m in discountObj)) {
                        discountObj[m] = {};
                        discountObj[m].discount = order[m].discount;
                        discountObj[m].count = 0;
                    } else {
                        discountObj[m].discount += order[m].discount;
                    }
                    if (order[m].discount > 0) {
                        discountObj[m].count ++;
                    }
                    for (var p in order[m]) {
                        if (typeof order[m][p] != 'object') {
                            continue;
                        }
                        if (!(p in orderObj[m])) {
                            orderObj[m][p] = order[m][p];
                            delete orderObj[m][p].price;
                            Psubtotal += order[m][p].subtotal;
                            Pcost += order[m][p].quantity * productsObj[m][p].cost;
                            if (timeDay == 13) {
                                orderObj[m][p].Q1 = order[m][p].quantity;
                                orderObj[m][p].T1 = order[m][p].subtotal;
                                orderObj[m][p].Q2 = 0;
                                orderObj[m][p].T2 = 0;
                            } else {
                                orderObj[m][p].Q1 = 0;
                                orderObj[m][p].T1 = 0;
                                orderObj[m][p].Q2 = order[m][p].quantity;
                                orderObj[m][p].T2 = order[m][p].subtotal;
                            }
                        } else {
                            orderObj[m][p].quantity += order[m][p].quantity;
                            orderObj[m][p].subtotal += order[m][p].subtotal;
                            Psubtotal += order[m][p].subtotal;
                            Pcost += order[m][p].quantity * productsObj[m][p].cost;
                            if (timeDay == 13) {
                                orderObj[m][p].Q1 += order[m][p].quantity;
                                orderObj[m][p].T1 += order[m][p].subtotal;
                            } else {
                                orderObj[m][p].Q2 += order[m][p].quantity;
                                orderObj[m][p].T2 += order[m][p].subtotal;
                            }
                        }
                    }
                }

                Pprofit = Psubtotal - Pcost - discount;

                pTbody.innerHTML += '<tr><td>' + year + '</td><td>' + month + '</td><td>' + day + '</td><td>' + hour + '</td><td>' + orderNumber + '</td><td>' + department + '</td><td>' + grade + '</td><td>' + coupon + '</td><td>' + tC(total) + '</td><td>' + tC(discount) + '</td><td>' + tC(Psubtotal) + '</td><td>' + tC(discount) + '</td><td>' + tC(Pcost) + '</td><td>' + tC(Pprofit) + '</td></tr>';

                
                if (!(day in timeObj)) {
                    timeObj[day] = {};
                }
                for (var j = 0; j < 24; j++) {
                    if (!(j in timeObj[day])) {
                        timeObj[day][j] = {'total': 0, 'discount': 0, 'Psubtotal': 0, 'Pcost': 0, 'Pprofit': 0};
                    }
                    if (!(j in timeHourList)) {
                        timeHourList[j] = {'total': 0, 'discount': 0, 'Psubtotal': 0, 'Pcost': 0, 'Pprofit': 0};
                    }
                    if (hour == j) {
                        timeObj[day][j].total += total;
                        timeObj[day][j].discount += discount;
                        timeObj[day][j].Psubtotal += Psubtotal;
                        timeObj[day][j].Pcost += Pcost;
                        timeObj[day][j].Pprofit += Pprofit;

                        timeHourList[j].total += total;
                        timeHourList[j].discount += discount;
                        timeHourList[j].Psubtotal += Psubtotal;
                        timeHourList[j].Pcost += Pcost;
                        timeHourList[j].Pprofit += Pprofit;
                    }
                }

                TPtotal += total
                TPdiscount += discount;
                TPsubtotal += Psubtotal;
                TPcost += Pcost;
                TPprofit += Pprofit;

            }

            pTbody.innerHTML += '<tr><td>' + '' + '</td><td>' + '' + '</td><td>' + '' + '</td><td>' + '' + '</td><td>' + '' + '</td><td>' + '' + '</td><td>' + '' + '</td><td>' + '' + '</td><td>' + tC(TPtotal) + '</td><td>' + tC(TPdiscount) + '</td><td>' + tC(TPsubtotal) + '</td><td>' + tC(TPdiscount) + '</td><td>' + tC(TPcost) + '</td><td>' + tC(TPprofit) + '</td></tr>';

            pTable.appendChild(pTbody);
            body.appendChild(pTable);



            var Tquantity = 0;
            var Tsubtotal = 0;
            var Tcost = 0;
            var Tprofit = 0;

            var TQ1 = 0;
            var TT1 = 0;
            var TQ2 = 0;
            var TT2 = 0;

            var table = document.createElement('table');
                table.id = 'prodcuts';
            for (var m in orderObj) {
                var Mquantity = 0;
                var Msubtotal = 0;
                var Mcost = 0;
                var Mprofit = 0;

                var MQ1 = 0;
                var MT1 = 0;
                var MQ2 = 0;
                var MT2 = 0;

                var tbody = document.createElement('tbody');
                    tbody.innerHTML += '<tr><th colspan=11>' + m + '</th></tr>';
                    var tr = document.createElement('tr');
                        tr.innerHTML += '<th>' + '廠商' + '</th>';
                        tr.innerHTML += '<th>' + '品名' + '</th>';
                        tr.innerHTML += '<th>' + '數量' + '</th>';
                        tr.innerHTML += '<th>' + '金額' + '</th>';
                        tr.innerHTML += '<th>' + '成本' + '</th>';
                        tr.innerHTML += '<th>' + '利潤' + '</th>';
                        tr.innerHTML += '<th>' + '品名' + '</th>';
                        tr.innerHTML += '<th>' + '數量 (D1)' + '</th>';
                        tr.innerHTML += '<th>' + '金額 (D1)' + '</th>';
                        tr.innerHTML += '<th>' + '數量 (D2)' + '</th>';
                        tr.innerHTML += '<th>' + '金額 (D2)' + '</th>';
                    tbody.appendChild(tr);

                for (var p in orderObj[m]) {
                    var tr = document.createElement('tr');
                        var merchant = m;
                        tr.innerHTML += '<td>' + m + '</td>';
                        var product = p;
                        tr.innerHTML += '<td>' + p + '</td>';
                        var quantity = orderObj[m][p].quantity;
                        Mquantity += quantity;
                        tr.innerHTML += '<td>' + quantity + '</td>';
                        var subtotal = orderObj[m][p].subtotal;
                        Msubtotal += subtotal;
                        tr.innerHTML += '<td>' + tC(subtotal) + '</td>';
                        var cost = orderObj[m][p].quantity * productsObj[m][p].cost;
                        Mcost += cost;
                        tr.innerHTML += '<td>' + tC(cost) + '</td>';
                        var profit = subtotal - cost;
                        Mprofit += profit;
                        tr.innerHTML += '<td>' + tC(profit) + '</td>';

                        var product = p;
                        tr.innerHTML += '<td>' + p + '</td>';
                        var Q1 = orderObj[m][p].Q1;
                        MQ1 += Q1;
                        tr.innerHTML += '<td>' + Q1 + '</td>';
                        var T1 = orderObj[m][p].T1;
                        MT1 += T1;
                        tr.innerHTML += '<td>' + tC(T1) + '</td>';
                        var Q2 = orderObj[m][p].Q2;
                        MQ2 += Q2;
                        tr.innerHTML += '<td>' + Q2 + '</td>';
                        var T2 = orderObj[m][p].T2;
                        MT2 += T2;
                        tr.innerHTML += '<td>' + tC(T2) + '</td>';

                    tbody.appendChild(tr);
                }
                    var tr = document.createElement('tr');
                        var Mdiscount = discountObj[m].discount;
                        var MdiscountC = discountObj[m].count;
                        tr.innerHTML += '<td>' + m + '</td>';
                        tr.innerHTML += '<td>' + 'Discount' + '</td>';
                        tr.innerHTML += '<td>' + MdiscountC + '</td>';
                        tr.innerHTML += '<td>' + tC(Mdiscount) + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + 'Discount' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                    tbody.appendChild(tr);
                    var tr = document.createElement('tr');
                        tr.innerHTML += '<td>' + m + '</td>';
                        tr.innerHTML += '<td>' + 'Total' + '</td>';
                        tr.innerHTML += '<td>' + Mquantity + '</td>';
                        tr.innerHTML += '<td>' + tC(Msubtotal) + '</td>';
                        tr.innerHTML += '<td>' + tC(Mcost) + '</td>';
                        tr.innerHTML += '<td>' + tC(Mprofit) + '</td>';
                        tr.innerHTML += '<td>' + 'Total' + '</td>';
                        tr.innerHTML += '<td>' + MQ1 + '</td>';
                        tr.innerHTML += '<td>' + tC(MT1) + '</td>';
                        tr.innerHTML += '<td>' + MQ2 + '</td>';
                        tr.innerHTML += '<td>' + tC(MT2) + '</td>';
                    tbody.appendChild(tr);
                    Tquantity += Mquantity;
                    Tsubtotal += Msubtotal;
                    Tcost += Mcost;
                    Tprofit += Mprofit;
                    TQ1 += MQ1;
                    TT1 += MT1;
                    TQ2 += MQ2;
                    TT2 += MT2;
                table.appendChild(tbody);
            }
                var tbody = document.createElement('tbody');
                    tbody.innerHTML += '<tr><th colspan=11>' + 'Total' + '</th></tr>';
                    var tr = document.createElement('tr');
                        tr.innerHTML += '<th>' + '廠商' + '</th>';
                        tr.innerHTML += '<th>' + '品名' + '</th>';
                        tr.innerHTML += '<th>' + '數量' + '</th>';
                        tr.innerHTML += '<th>' + '金額' + '</th>';
                        tr.innerHTML += '<th>' + '成本' + '</th>';
                        tr.innerHTML += '<th>' + '利潤' + '</th>';
                        tr.innerHTML += '<th>' + '品名' + '</th>';
                        tr.innerHTML += '<th>' + '數量 (D1)' + '</th>';
                        tr.innerHTML += '<th>' + '金額 (D1)' + '</th>';
                        tr.innerHTML += '<th>' + '數量 (D2)' + '</th>';
                        tr.innerHTML += '<th>' + '金額 (D2)' + '</th>';
                    tbody.appendChild(tr);
                    var tr = document.createElement('tr');
                        var Tdiscount = discountObj.total.discount;
                        var TdiscountC = discountObj.total.count;
                        tr.innerHTML += '<td>' + 'Total' + '</td>';
                        tr.innerHTML += '<td>' + 'Discount' + '</td>';
                        tr.innerHTML += '<td>' + TdiscountC + '</td>';
                        tr.innerHTML += '<td>' + tC(Tdiscount) + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + 'Discount' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                        tr.innerHTML += '<td>' + '' + '</td>';
                    tbody.appendChild(tr);
                    var tr = document.createElement('tr');
                        tr.innerHTML += '<td>' + 'Total' + '</td>';
                        tr.innerHTML += '<td>' + 'Total' + '</td>';
                        tr.innerHTML += '<td>' + Tquantity + '</td>';
                        tr.innerHTML += '<td>' + tC(Tsubtotal) + '</td>';
                        tr.innerHTML += '<td>' + tC(Tcost) + '</td>';
                        tr.innerHTML += '<td>' + tC(Tprofit) + '</td>';
                        tr.innerHTML += '<td>' + 'Total' + '</td>';
                        tr.innerHTML += '<td>' + TQ1 + '</td>';
                        tr.innerHTML += '<td>' + tC(TT1) + '</td>';
                        tr.innerHTML += '<td>' + TQ2 + '</td>';
                        tr.innerHTML += '<td>' + tC(TT2) + '</td>';
                    tbody.appendChild(tr);
                table.appendChild(tbody);
            body.appendChild(table);


            var timeTable = document.createElement('table');
                timeTable.id = 'time';

                var timeTbody = document.createElement('tbody');
                    timeTbody.innerHTML += '<tr><th>' + '日' + '</th><th>' + '時' + '</th><th>' + '金額' + '</th><th>' + '小計'  + '</th><th>' + '折扣'+ '</th><th>' + '成本' + '</th><th>' + '利潤' + '</th></tr>';
                timeTable.appendChild(timeTbody);

                for (var d in timeObj) {
                    var Dtotal = 0;
                    var Ddiscount = 0;
                    var DPsubtotal = 0;
                    var DPcost = 0;
                    var DPprofit = 0;

                    var timeTbody = document.createElement('tbody');
                    for (var h in timeObj[d]) {

                        var total = timeObj[d][h].total;
                        var discount = timeObj[d][h].discount;
                        var Psubtotal = timeObj[d][h].Psubtotal;
                        var Pcost = timeObj[d][h].Pcost;
                        var Pprofit = timeObj[d][h].Pprofit;

                        timeTbody.innerHTML += '<tr><td>' + d + '</td><td>' + h + '</td><td>' + tC(total) + '</td><td>' + tC(Psubtotal) + '</td><td>'  + tC(discount) + '</td><td>'+ tC(Pcost) + '</td><td>' + tC(Pprofit) + '</td></tr>';
                        
                        Dtotal += total;
                        Ddiscount += discount;
                        DPsubtotal += Psubtotal;
                        DPcost += Pcost;
                        DPprofit += Pprofit;
                    }

                        timeTbody.innerHTML += '<tr><td>' + d + '</td><td>' + 'total' + '</td><td>' + tC(Dtotal) + '</td><td>' + tC(DPsubtotal) + '</td><td>'  + tC(Ddiscount) + '</td><td>'+ tC(DPcost) + '</td><td>' + tC(DPprofit) + '</td></tr>';

                timeTable.appendChild(timeTbody);
                }

                for (var h in timeHourList) {

                        var TimeHourtotal = timeHourList[h].total;
                        var TimeHourdiscount = timeHourList[h].discount;
                        var TimeHourPsubtotal = timeHourList[h].Psubtotal;
                        var TimeHourPcost = timeHourList[h].Pcost;
                        var TimeHourPprofit = timeHourList[h].Pprofit;

                        timeTbody.innerHTML += '<tr><td>' + '' + '</td><td>' + h + '</td><td>' + tC(TimeHourtotal) + '</td><td>' + tC(TimeHourPsubtotal)  + '</td><td>' + tC(TimeHourdiscount)+ '</td><td>' + tC(TimeHourPcost) + '</td><td>' + tC(TimeHourPprofit) + '</td></tr>';

                timeTable.appendChild(timeTbody);
                }

            body.appendChild(timeTable);


            document.querySelector('#customers').classList.add('hide');
            document.querySelector('#prodcuts').classList.add('hide');
            document.querySelector('#time').classList.add('hide');

            document.querySelector('button[name="customers"]').disabled = '';
            document.querySelector('button[name="prodcuts"]').disabled = '';
            document.querySelector('button[name="time"]').disabled = '';

        });
    });

    function tC(num){
        var parts = num.toString().split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        return '$' + parts.join('.');
    }

    $(function() {
        document.querySelector('button[name="customers"]').disabled = 'disabled';
        document.querySelector('button[name="prodcuts"]').disabled = 'disabled';
        document.querySelector('button[name="time"]').disabled = 'disabled';
        $('button[name="customers"]').on('click', function(ev){
            document.querySelector('#customers').classList.remove('hide');
            document.querySelector('#prodcuts').classList.add('hide');
            document.querySelector('#time').classList.add('hide');
        });
        $('button[name="prodcuts"]').on('click', function(ev){
            document.querySelector('#customers').classList.add('hide');
            document.querySelector('#prodcuts').classList.remove('hide');
            document.querySelector('#time').classList.add('hide');
        });
        $('button[name="time"]').on('click', function(ev){
            document.querySelector('#customers').classList.add('hide');
            document.querySelector('#prodcuts').classList.add('hide');
            document.querySelector('#time').classList.remove('hide');
        });
    });

</script>
<style>
    * {
        box-sizing: border-box;
    }
    body {
        font-size: 0.5em;
    }
    table {
        border-collapse: collapse;
        width: 100%;
    }
    tbody, tr {
        width: 100%;
    }
    th, td {
        text-align: center;
        border: 1px #000 solid;
    }
    tr:hover {
        background-color: #FF9;
    }
    td:hover {
        background-color: #FF0;
    }
    .hide {
        display: none;
    }
</style>
<body>
    <button type="button" name="customers">
        顧客
    </button>
    <button type="button" name="prodcuts">
        商品
    </button>
    <button type="button" name="time">
        分時
    </button>
</body>
</html>